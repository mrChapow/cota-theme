{{ '3d-interactive.css' | asset_url | stylesheet_tag }}

{%- style -%}
  :root {
    --desktop-price-top: {{ section.settings.desktop_price_top | default: 25 }}vh;
    --desktop-desc-top: {{ section.settings.desktop_desc_top | default: 45 }}vh;
    --desktop-panels-right: {{ section.settings.desktop_panels_right | default: 25 }}vw;
    --desktop-panel-width: 350px;
    --mobile-price-bottom: {{ section.settings.mobile_price_bottom | default: 22 }}vh;
    --mobile-desc-bottom: {{ section.settings.mobile_desc_bottom | default: 6 }}vh;
    --mobile-panel-width: 90vw;
    --mobile-panel-max-width: 400px;
  }
{%- endstyle -%}

<div class="interactive-3d-container">
  <!-- 3D Canvas Container -->
  <div class="canvas-container">
    <canvas id="three-canvas"></canvas>
    
    <!-- Price Panel -->
    <div class="glass-panel price-panel" id="price-panel">
      <div style="text-align: center;">
        {%- if section.settings.product != blank -%}
          <h2>{{ section.settings.product.title | default: 'Product' }}</h2>
          <h1>{{ section.settings.product.price | money | default: '$299.99' }}</h1>
          
          <!-- Shopify Add to Cart Form -->
          {%- form 'product', section.settings.product, id: 'product-form', class: 'form', novalidate: 'novalidate', data-type: 'add-to-cart-form' -%}
            <input type="hidden" name="id" value="{{ section.settings.product.selected_or_first_available_variant.id }}">
            
            <div class="product-form__buttons">
              <button
                id="ProductSubmitButton"
                type="submit"
                name="add"
                class="buy-button btn product-form__cart-submit{% if section.settings.product.selected_or_first_available_variant.available == false %} disabled{% endif %}"
                {% if section.settings.product.selected_or_first_available_variant.available == false %}disabled{% endif %}
              >
                <span>
                  {%- if section.settings.product.selected_or_first_available_variant.available -%}
                    {{ 'products.product.add_to_cart' | t }}
                  {%- else -%}
                    {{ 'products.product.sold_out' | t }}
                  {%- endif -%}
                </span>
                <div class="loading-overlay__spinner hidden">
                  <svg aria-hidden="true" focusable="false" class="spinner" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                    <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
                  </svg>
                </div>
              </button>
            </div>
          {%- endform -%}
        {%- else -%}
          <h2>{{ section.settings.title | default: 'Product' }}</h2>
          <h1>{{ section.settings.price | default: '$299.99' }}</h1>
          <button class="buy-button" onclick="handlePurchase()">
            {{ section.settings.button_text | default: 'Buy' }}
          </button>
        {%- endif -%}
      </div>
    </div>

    <!-- Description Panel -->
    <div class="glass-panel description-panel" id="description-panel">
      <div>
        <h2>{{ section.settings.description_title | default: 'Product Description:' }}</h2>
        <div style="margin-top: 12px;">
          <p style="margin-bottom: 12px;">
            {%- if section.settings.product != blank -%}
              {{ section.settings.product.description | default: 'Interactive 3D Product Display' | strip_html | truncate: 100 }}
            {%- else -%}
              {{ section.settings.description | default: 'Interactive 3D Product Display' }}
            {%- endif -%}
          </p>
          {%- if section.settings.contact_email != blank -%}
            <p class="text-sm" style="opacity: 0.8;">
              Questions? {{ section.settings.contact_email }}
            </p>
          {%- endif -%}
        </div>
      </div>
    </div>
  </div>

  <!-- Email Collection Modal (for out of stock items) -->
  <div class="modal-overlay" id="email-modal">
    <div class="modal-content">
      <button class="close-button" onclick="closeModal()">&times;</button>
      <h2 class="modal-title">{{ section.settings.modal_title | default: 'Thank you for your interest!' }}</h2>
      <p class="modal-text">{{ section.settings.modal_text | default: "Unfortunately, this item isn't available yet. We'd love to keep in contact." }}</p>
      
      <!-- Shopify Customer Form -->
      {%- form 'customer', customer, class: 'newsletter-form' -%}
        <input name="contact[tags]" type="hidden" value="product-newsletter">
        <div class="form-group">
          <label class="form-label">ðŸ“§ Email:</label>
          <input 
            type="email" 
            name="contact[email]"
            class="form-input" 
            placeholder="your@email.com" 
            required
            autocorrect="off"
            autocapitalize="off"
          >
        </div>
        
        <div class="form-group">
          <label class="form-label">ðŸ“· Instagram:</label>
          <input 
            type="text" 
            name="contact[note][instagram]"
            class="form-input" 
            placeholder="@yourusername"
          >
        </div>
        
        <button type="submit" class="submit-button">
          {{ section.settings.submit_button_text | default: 'Submit' }}
        </button>
      {%- endform -%}
      
      <!-- Early Support Link -->
      {%- if section.settings.early_support_url != blank -%}
        <a href="{{ section.settings.early_support_url }}" 
           target="_blank" 
           class="early-support-link">
          {{ section.settings.early_support_text | default: "I don't care, I want to buy this early in support." }}
        </a>
      {%- endif -%}
    </div>
  </div>
</div>

<script>
  // Product-specific JavaScript variables
  window.interactiveProduct = {
    {%- if section.settings.product != blank -%}
      id: {{ section.settings.product.id | json }},
      title: {{ section.settings.product.title | json }},
      price: {{ section.settings.product.price | money_without_currency | json }},
      available: {{ section.settings.product.available | json }},
      description: {{ section.settings.product.description | strip_html | truncate: 100 | json }}
    {%- else -%}
      id: null,
      title: {{ section.settings.title | default: 'Helm' | json }},
      price: {{ section.settings.price | default: '299.99' | json }},
      available: {{ section.settings.available | default: true | json }},
      description: {{ section.settings.description | default: 'Cota Pilot Project' | json }}
    {%- endif -%}
  };
</script>

{{ '3d-interactive.js' | asset_url | script_tag }}

{% schema %}
{
  "name": "3D Interactive Product Hero",
  "settings": [
    {
      "type": "header",
      "content": "Product Selection"
    },
    {
      "type": "product",
      "id": "product",
      "label": "Product",
      "info": "Select a product to display. Leave empty for custom content."
    },
    {
      "type": "header", 
      "content": "Custom Content (when no product selected)"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Product title",
      "default": "Helm"
    },
    {
      "type": "text",
      "id": "price", 
      "label": "Price",
      "default": "$299.99"
    },
    {
      "type": "text",
      "id": "description",
      "label": "Description",
      "default": "Cota Pilot Project"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text", 
      "default": "Buy"
    },
    {
      "type": "checkbox",
      "id": "available",
      "label": "Available for purchase",
      "default": true
    },
    {
      "type": "header",
      "content": "Panel Content"
    },
    {
      "type": "text",
      "id": "description_title",
      "label": "Description panel title",
      "default": "Product Description:"
    },
    {
      "type": "text",
      "id": "contact_email",
      "label": "Support email",
      "default": "support@helm.com"
    },
    {
      "type": "header",
      "content": "Email Modal Content"
    },
    {
      "type": "text",
      "id": "modal_title",
      "label": "Modal title",
      "default": "Thank you for your interest!"
    },
    {
      "type": "textarea",
      "id": "modal_text", 
      "label": "Modal description",
      "default": "Unfortunately, this item isn't available yet. We'd love to keep in contact."
    },
    {
      "type": "text",
      "id": "submit_button_text",
      "label": "Submit button text",
      "default": "Submit"
    },
    {
      "type": "url",
      "id": "early_support_url",
      "label": "Early support purchase URL"
    },
    {
      "type": "text",
      "id": "early_support_text",
      "label": "Early support link text",
      "default": "I don't care, I want to buy this early in support."
    },
    {
      "type": "header",
      "content": "Positioning (Desktop)"
    },
    {
      "type": "range",
      "id": "desktop_price_top",
      "min": 10,
      "max": 90,
      "step": 5,
      "unit": "vh",
      "label": "Price panel top position",
      "default": 25
    },
    {
      "type": "range",
      "id": "desktop_desc_top",
      "min": 10, 
      "max": 90,
      "step": 5,
      "unit": "vh",
      "label": "Description panel top position",
      "default": 45
    },
    {
      "type": "range",
      "id": "desktop_panels_right",
      "min": 10,
      "max": 40,
      "step": 5,
      "unit": "vw",
      "label": "Panels right position",
      "default": 25
    },
    {
      "type": "header",
      "content": "Positioning (Mobile)"
    },
    {
      "type": "range", 
      "id": "mobile_price_bottom",
      "min": 10,
      "max": 90,
      "step": 2,
      "unit": "vh",
      "label": "Price panel bottom position",
      "default": 22
    },
    {
      "type": "range",
      "id": "mobile_desc_bottom",
      "min": 2,
      "max": 50,
      "step": 2,
      "unit": "vh",
      "label": "Description panel bottom position",
      "default": 6
    }
  ],
  "presets": [
    {
      "name": "Helm 3D Product Hero"
    }
  ]
}
{% endschema %}